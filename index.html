<head>
    <link rel="stylesheet" href="styles.css">
    <script src="https://unpkg.com/3d-force-graph"></script>
</head>

<body>
    <div id="idea-web"></div>
    <button id="btn-add" onclick="onAddItemClick()">Add Idea</button>
    <div id="modal-idea-new">
        <form id="form-idea-new" onsubmit="onModalSubmitClick(event, this)">
            Idea Name:<br>
            <input type="text" name="idea-name">
            <br>
            Description:<br>
            <input type="text" name="description">
            <br>
            Topics (comma separated):<br>
            <input type="text" name="tags">
            <br>
            Your Name (optional):<br>
            <input type="text" name="creator-name">
            <br><br>
            <input type="submit">
        </form>
    </div>

    <div id="modal-detail">
        <b><span id="detail-name"></span></b><br><br>
        Topics: <span id="detail-tags"></span>
    </div>

    <script>
        const web = document.getElementById('idea-web');
        const data = {
            nodes: [
                {
                    id: 0, val: 1, name: "Dance Visualizer", tags: new Set(["computer vision", "dance"]),
                    description: "Take old dance videos as input and track movements to create visualizations", creator: "Sruti"
                },
                {
                    id: 1, val: 1, name: "Route Optimizer", tags: new Set(["routing", "constraint optimization"]),
                    description: "Find optimal route for multiple locations and time constraints", creator: "Sruti"
                },
                {
                    id: 2, val: 1, name: "Dance Moves Database", tags: new Set(["computer vision", "dance", "machine learning"]),
                    description: "Analyze dance moves from different styles to learn and understand history", creator: "Marko"
                },
                {
                    id: 3, val: 1, name: "Meet in the Middle", tags: new Set(["routing", "constraint optimization", "machine learning"]),
                    description: "Find a convenient meeting point for two people in different locations", creator: "Dan"
                }],
            links: [{ source: 0, target: 2 }, { source: 1, target: 3 }, { source: 2, target: 3 }]
        };

        const Graph = ForceGraph3D()
            (web)
            .graphData(data)
            .nodeLabel('name')
            .onNodeHover(node => web.style.cursor = node ? 'pointer' : null)
            .onNodeClick(node => {
                // Aim at node from outside it
                const distance = 40;
                const distRatio = 1 + distance / Math.hypot(node.x, node.y, node.z);

                Graph.cameraPosition(
                    { x: node.x * distRatio, y: node.y * distRatio, z: node.z * distRatio }, // new position
                    node, // lookAt ({ x, y, z })
                    3000  // ms transition duration
                );
                detailDisplay(node);
            });

        function onAddItemClick() {
            const modal = document.getElementById("modal-idea-new");
            modal.style.display = "block";
        }

        function onModalSubmitClick(event, form) {
            event.preventDefault();
            const modal = document.getElementById("modal-idea-new");
            const ideaName = form["idea-name"];
            const ideaTags = form["tags"];
            const ideaDescription = form["description"];
            const creatorName = form["creator-name"];

            const { nodes, links } = Graph.graphData();
            const id = nodes.length;

            const newIdea = {
                id: id,
                name: ideaName.value,
                tags: new Set(ideaTags.value.split(",").map(tag => tag.trim().toLowerCase())),
                creator: creatorName.value,
                description: ideaDescription.value,
            };

            modal.style.display = "none";
            form.reset();

            var newLinks = [];

            for (idea of nodes) {
                var intersection = new Set([...idea.tags].filter(x => newIdea.tags.has(x)));
                if (intersection.size != 0) {
                    newLinks = [...newLinks, { source: newIdea.id, target: idea.id }]
                }
            }

            Graph.graphData({
                nodes: [...nodes, { ...newIdea }],
                links: [...links, ...newLinks]
            });
        }

        function detailDisplay(node) {
            const modal = document.getElementById("modal-detail");
            const detailName = document.getElementById("detail-name");
            const detailTags = document.getElementById("detail-tags");

            detailName.textContent = node.name;
            detailTags.textContent = [...node.tags].join(', ');

            modal.style.top = event.pageY;
            modal.style.left = event.pageX;
            modal.style.display = 'block';
        }

        window.onclick = function (event) {
            if (event.target == document.getElementById("modal-detail")) {
                document.getElementById("modal-detail").style.display = "none";
            }
        }

    </script>
</body>